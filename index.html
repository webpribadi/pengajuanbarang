<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulir Pengadaan Barang - SMPN 17 Depok</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'blue-primary': '#0f172a',
                        'blue-secondary': '#1e293b',
                        'blue-accent': '#3b82f6',
                        'blue-light': '#f1f5f9',
                        'blue-gradient': '#0ea5e9'
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 50%, #6366f1 100%);
        }
        .container-modern {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .input-modern {
            transition: all 0.3s ease;
            border: 2px solid #e2e8f0;
        }
        .input-modern:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }
        .section-card {
            background: linear-gradient(145deg, #f8fafc 0%, #ffffff 100%);
            border-left: 4px solid #3b82f6;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen py-4 sm:py-8">
    <div class="max-w-lg mx-auto px-3 sm:max-w-4xl sm:px-4">
        <!-- Header -->
        <div class="glass-effect rounded-xl sm:rounded-2xl shadow-2xl mb-6 sm:mb-8 p-4 sm:p-8 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-accent via-blue-gradient to-purple-500"></div>
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start space-y-4 sm:space-y-0">
                <div class="text-left flex-1">
                    <h1 class="text-2xl sm:text-4xl font-bold text-blue-primary mb-2 sm:mb-3 tracking-tight">SMPN 17 DEPOK</h1>
                    <h2 class="text-lg sm:text-2xl font-semibold text-blue-secondary tracking-wide">FORMULIR PENGADAAN BARANG</h2>
                </div>
                <div class="text-center sm:text-right text-sm text-blue-secondary bg-blue-light px-3 sm:px-4 py-2 sm:py-3 rounded-lg sm:rounded-xl shadow-sm">
                    <div class="font-semibold mb-1">Tanggal & Waktu</div>
                    <div id="current-date" class="font-medium text-xs sm:text-sm"></div>
                    <div id="current-time" class="font-medium text-blue-accent text-xs sm:text-sm"></div>
                </div>
            </div>
        </div>

        <!-- Form -->
        <form class="container-modern rounded-xl sm:rounded-2xl p-4 sm:p-10 space-y-6 sm:space-y-10">
            <!-- 1. Identitas Pengaju -->
            <div class="section-card rounded-lg sm:rounded-xl p-4 sm:p-6">
                <h3 class="text-lg sm:text-xl font-bold text-blue-primary mb-4 sm:mb-6 flex items-center">
                    <span class="bg-blue-accent text-white w-7 h-7 sm:w-8 sm:h-8 rounded-full flex items-center justify-center text-xs sm:text-sm font-bold mr-2 sm:mr-3">1</span>
                    <span class="text-sm sm:text-base">IDENTITAS PENGAJU</span>
                </h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-blue-secondary mb-2 sm:mb-3">Nama Lengkap</label>
                        <input type="text" class="input-modern w-full px-3 sm:px-4 py-3 sm:py-4 rounded-lg sm:rounded-xl focus:outline-none text-sm sm:text-base" placeholder="Masukkan nama lengkap">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-blue-secondary mb-2 sm:mb-3">Jabatan</label>
                        <select class="input-modern w-full px-3 sm:px-4 py-3 sm:py-4 rounded-lg sm:rounded-xl focus:outline-none text-sm sm:text-base">
                            <option value="">Pilih Jabatan</option>
                            <option value="kepala-sekolah">Kepala Sekolah</option>
                            <option value="wakil-kepala">Wakil Kepala</option>
                            <option value="guru">Guru</option>
                            <option value="pembina-ekskul">Pembina Ekskul</option>
                            <option value="tas">TAS</option>
                            <option value="caraka">Caraka</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 2. Detail Barang -->
            <div class="section-card rounded-lg sm:rounded-xl p-4 sm:p-6">
                <h3 class="text-lg sm:text-xl font-bold text-blue-primary mb-4 sm:mb-6 flex items-center">
                    <span class="bg-blue-accent text-white w-7 h-7 sm:w-8 sm:h-8 rounded-full flex items-center justify-center text-xs sm:text-sm font-bold mr-2 sm:mr-3">2</span>
                    <span class="text-sm sm:text-base">DETAIL BARANG YANG DIAJUKAN</span>
                </h3>
                <div id="barang-container">
                    <div class="barang-item bg-gradient-to-r from-blue-light to-white p-4 sm:p-6 rounded-lg sm:rounded-xl mb-4 sm:mb-6 border border-blue-200 shadow-sm">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3 sm:gap-4">
                            <div class="sm:col-span-2 lg:col-span-1">
                                <label class="block text-sm font-semibold text-blue-secondary mb-2">Nama Barang</label>
                                <input type="text" class="input-modern w-full px-3 py-2 sm:px-4 sm:py-3 rounded-lg sm:rounded-xl focus:outline-none text-sm" placeholder="Nama barang">
                            </div>
                            <div class="sm:col-span-2 lg:col-span-1">
                                <label class="block text-sm font-semibold text-blue-secondary mb-2">Spesifikasi</label>
                                <input type="text" class="input-modern w-full px-3 py-2 sm:px-4 sm:py-3 rounded-lg sm:rounded-xl focus:outline-none text-sm" placeholder="Spesifikasi">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-blue-secondary mb-2">Jumlah</label>
                                <input type="number" class="jumlah input-modern w-full px-3 py-2 sm:px-4 sm:py-3 rounded-lg sm:rounded-xl focus:outline-none text-sm" placeholder="0" min="1">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-blue-secondary mb-2">Harga Satuan</label>
                                <input type="number" class="harga input-modern w-full px-3 py-2 sm:px-4 sm:py-3 rounded-lg sm:rounded-xl focus:outline-none text-sm" placeholder="0" min="0">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-blue-secondary mb-2">Total Harga</label>
                                <input type="text" class="total-harga w-full px-3 py-2 sm:px-4 sm:py-3 bg-blue-light border-2 border-blue-200 rounded-lg sm:rounded-xl font-semibold text-blue-primary text-sm" readonly placeholder="Rp 0">
                            </div>
                        </div>
                        <button type="button" class="hapus-barang mt-3 sm:mt-4 text-red-500 hover:text-red-700 text-sm font-semibold transition-colors" onclick="hapusBarang(this)">üóëÔ∏è Hapus Barang</button>
                    </div>
                </div>
                <button type="button" class="bg-gradient-to-r from-blue-accent to-blue-gradient hover:from-blue-600 hover:to-blue-700 text-white px-4 sm:px-6 py-2 sm:py-3 rounded-lg sm:rounded-xl font-semibold transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1 text-sm sm:text-base" onclick="tambahBarang()">‚ûï Tambah Barang</button>
                
                <div class="mt-6 sm:mt-8 p-4 sm:p-6 bg-gradient-to-r from-blue-primary to-blue-secondary text-white rounded-lg sm:rounded-xl shadow-lg">
                    <div class="text-center sm:text-right">
                        <span class="text-base sm:text-lg font-medium">Total Keseluruhan: </span>
                        <span id="grand-total" class="text-xl sm:text-2xl font-bold block sm:inline">Rp 0</span>
                    </div>
                </div>
            </div>

            <!-- 3. Alasan Kegunaan -->
            <div class="section-card rounded-lg sm:rounded-xl p-4 sm:p-6">
                <h3 class="text-lg sm:text-xl font-bold text-blue-primary mb-4 sm:mb-6 flex items-center">
                    <span class="bg-blue-accent text-white w-7 h-7 sm:w-8 sm:h-8 rounded-full flex items-center justify-center text-xs sm:text-sm font-bold mr-2 sm:mr-3">3</span>
                    <span class="text-sm sm:text-base">ALASAN KEGUNAAN</span>
                </h3>
                <textarea class="input-modern w-full px-3 sm:px-4 py-3 sm:py-4 rounded-lg sm:rounded-xl focus:outline-none resize-none text-sm sm:text-base" rows="4" placeholder="Jelaskan alasan dan kegunaan barang yang diajukan..."></textarea>
            </div>

            <!-- 4. Tingkat Urgensi -->
            <div class="section-card rounded-lg sm:rounded-xl p-4 sm:p-6">
                <h3 class="text-lg sm:text-xl font-bold text-blue-primary mb-4 sm:mb-6 flex items-center">
                    <span class="bg-blue-accent text-white w-7 h-7 sm:w-8 sm:h-8 rounded-full flex items-center justify-center text-xs sm:text-sm font-bold mr-2 sm:mr-3">4</span>
                    <span class="text-sm sm:text-base">TINGKAT URGENSI</span>
                </h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4">
                    <label class="flex items-center p-3 sm:p-4 bg-gradient-to-r from-red-50 to-red-100 rounded-lg sm:rounded-xl border-2 border-red-200 cursor-pointer hover:shadow-md transition-all">
                        <input type="radio" name="urgensi" value="sangat-mendesak" class="w-4 h-4 sm:w-5 sm:h-5 text-red-600 focus:ring-red-500">
                        <span class="ml-2 sm:ml-3 font-semibold text-red-700 text-sm sm:text-base">üî¥ Sangat Mendesak</span>
                    </label>
                    <label class="flex items-center p-3 sm:p-4 bg-gradient-to-r from-yellow-50 to-yellow-100 rounded-lg sm:rounded-xl border-2 border-yellow-200 cursor-pointer hover:shadow-md transition-all">
                        <input type="radio" name="urgensi" value="perlu" class="w-4 h-4 sm:w-5 sm:h-5 text-yellow-600 focus:ring-yellow-500">
                        <span class="ml-2 sm:ml-3 font-semibold text-yellow-700 text-sm sm:text-base">üü° Perlu</span>
                    </label>
                    <label class="flex items-center p-3 sm:p-4 bg-gradient-to-r from-green-50 to-green-100 rounded-lg sm:rounded-xl border-2 border-green-200 cursor-pointer hover:shadow-md transition-all">
                        <input type="radio" name="urgensi" value="tidak-mendesak" class="w-4 h-4 sm:w-5 sm:h-5 text-green-600 focus:ring-green-500">
                        <span class="ml-2 sm:ml-3 font-semibold text-green-700 text-sm sm:text-base">üü¢ Tidak Mendesak</span>
                    </label>
                </div>
            </div>

            <!-- 5. Catatan Tambahan -->
            <div class="section-card rounded-lg sm:rounded-xl p-4 sm:p-6">
                <h3 class="text-lg sm:text-xl font-bold text-blue-primary mb-4 sm:mb-6 flex items-center">
                    <span class="bg-blue-accent text-white w-7 h-7 sm:w-8 sm:h-8 rounded-full flex items-center justify-center text-xs sm:text-sm font-bold mr-2 sm:mr-3">5</span>
                    <span class="text-sm sm:text-base">CATATAN TAMBAHAN</span>
                </h3>
                <textarea class="input-modern w-full px-3 sm:px-4 py-3 sm:py-4 rounded-lg sm:rounded-xl focus:outline-none resize-none text-sm sm:text-base" rows="3" placeholder="Catatan atau informasi tambahan (opsional)..."></textarea>
            </div>

            <!-- Submit Button -->
            <div class="text-center pt-6 sm:pt-8 space-y-4 sm:space-y-0 sm:space-x-4 flex flex-col sm:flex-row justify-center items-center">
                <button type="submit" class="bg-gradient-to-r from-blue-accent to-blue-gradient hover:from-blue-600 hover:to-blue-700 text-white px-8 sm:px-12 py-3 sm:py-4 rounded-xl sm:rounded-2xl font-bold text-base sm:text-lg transition-all duration-300 shadow-2xl hover:shadow-3xl transform hover:-translate-y-2 hover:scale-105 w-full sm:w-auto">
                    üìã Ajukan Permohonan
                </button>
                <button type="button" id="lihat-progress" class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-8 sm:px-12 py-3 sm:py-4 rounded-xl sm:rounded-2xl font-bold text-base sm:text-lg transition-all duration-300 shadow-2xl hover:shadow-3xl transform hover:-translate-y-2 hover:scale-105 w-full sm:w-auto">
                    üìä Lihat Progress
                </button>
            </div>
        </form>

        <!-- Dashboard Progress -->
        <div id="dashboard" class="container-modern rounded-xl sm:rounded-2xl p-4 sm:p-10 space-y-6 sm:space-y-8 hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl sm:text-3xl font-bold text-blue-primary">üìä Dashboard Progress Pengadaan</h2>
                <button id="kembali-form" class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white px-4 sm:px-6 py-2 sm:py-3 rounded-lg sm:rounded-xl font-semibold transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1 text-sm sm:text-base">
                    ‚Üê Kembali ke Form
                </button>
            </div>

            <!-- Loading State -->
            <div id="loading-dashboard" class="text-center py-12">
                <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-accent mx-auto mb-4"></div>
                <p class="text-blue-secondary font-medium">Memuat data progress...</p>
            </div>

            <!-- Dashboard Content -->
            <div id="dashboard-content" class="hidden space-y-6">
                <!-- Summary Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 sm:p-6 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100 text-sm">Total Pengajuan</p>
                                <p id="total-pengajuan" class="text-2xl sm:text-3xl font-bold">0</p>
                            </div>
                            <div class="text-3xl sm:text-4xl">üìã</div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 sm:p-6 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100 text-sm">Total Nilai</p>
                                <p id="total-nilai" class="text-xl sm:text-2xl font-bold">Rp 0</p>
                            </div>
                            <div class="text-3xl sm:text-4xl">üí∞</div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 text-white p-4 sm:p-6 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-yellow-100 text-sm">Mendesak</p>
                                <p id="total-mendesak" class="text-2xl sm:text-3xl font-bold">0</p>
                            </div>
                            <div class="text-3xl sm:text-4xl">üî¥</div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 sm:p-6 rounded-xl shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100 text-sm">Pengaju Aktif</p>
                                <p id="total-pengaju" class="text-2xl sm:text-3xl font-bold">0</p>
                            </div>
                            <div class="text-3xl sm:text-4xl">üë•</div>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Urgensi Chart -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-blue-100">
                        <h3 class="text-lg font-bold text-blue-primary mb-4">üìä Distribusi Tingkat Urgensi</h3>
                        <div id="urgensi-chart" class="space-y-3">
                            <!-- Chart akan diisi dengan JavaScript -->
                        </div>
                    </div>

                    <!-- Jabatan Chart -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-blue-100">
                        <h3 class="text-lg font-bold text-blue-primary mb-4">üë• Pengajuan per Jabatan</h3>
                        <div id="jabatan-chart" class="space-y-3">
                            <!-- Chart akan diisi dengan JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Recent Submissions -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-blue-100">
                    <h3 class="text-lg font-bold text-blue-primary mb-4">üìù Pengajuan Terbaru</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="bg-blue-50 text-blue-primary">
                                    <th class="text-left p-3 rounded-l-lg">Tanggal</th>
                                    <th class="text-left p-3">Nama</th>
                                    <th class="text-left p-3">Jabatan</th>
                                    <th class="text-left p-3">Total Nilai</th>
                                    <th class="text-left p-3 rounded-r-lg">Urgensi</th>
                                </tr>
                            </thead>
                            <tbody id="recent-submissions">
                                <!-- Data akan diisi dengan JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Fungsi untuk menghitung total harga per barang
        function hitungTotal(element) {
            const container = element.closest('.barang-item');
            const jumlah = container.querySelector('.jumlah').value || 0;
            const harga = container.querySelector('.harga').value || 0;
            const total = jumlah * harga;
            
            container.querySelector('.total-harga').value = 'Rp ' + total.toLocaleString('id-ID');
            hitungGrandTotal();
        }

        // Fungsi untuk menghitung total keseluruhan
        function hitungGrandTotal() {
            let grandTotal = 0;
            document.querySelectorAll('.barang-item').forEach(item => {
                const jumlah = item.querySelector('.jumlah').value || 0;
                const harga = item.querySelector('.harga').value || 0;
                grandTotal += jumlah * harga;
            });
            
            document.getElementById('grand-total').textContent = 'Rp ' + grandTotal.toLocaleString('id-ID');
        }

        // Fungsi untuk menambah barang baru
        function tambahBarang() {
            const container = document.getElementById('barang-container');
            const newItem = document.querySelector('.barang-item').cloneNode(true);
            
            // Reset nilai input
            newItem.querySelectorAll('input').forEach(input => {
                if (input.type === 'text' || input.type === 'number') {
                    input.value = '';
                }
            });
            
            container.appendChild(newItem);
            
            // Tambahkan event listener untuk item baru
            addEventListeners(newItem);
        }

        // Fungsi untuk menghapus barang
        function hapusBarang(button) {
            const items = document.querySelectorAll('.barang-item');
            if (items.length > 1) {
                button.closest('.barang-item').remove();
                hitungGrandTotal();
            } else {
                alert('Minimal harus ada satu barang yang diajukan');
            }
        }

        // Fungsi untuk menambahkan event listener
        function addEventListeners(container) {
            const jumlahInput = container.querySelector('.jumlah');
            const hargaInput = container.querySelector('.harga');
            
            jumlahInput.addEventListener('input', function() {
                hitungTotal(this);
            });
            
            hargaInput.addEventListener('input', function() {
                hitungTotal(this);
            });
        }

        // Fungsi untuk menampilkan tanggal dan jam
        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            const dateString = now.toLocaleDateString('id-ID', options);
            const timeString = now.toLocaleTimeString('id-ID');
            
            document.getElementById('current-date').textContent = dateString;
            document.getElementById('current-time').textContent = timeString;
        }

        // Fungsi untuk mengirim data ke Google Spreadsheet
        async function kirimKeSpreadsheet(formData) {
            // URL Google Apps Script untuk menyimpan data ke spreadsheet
            const GAS_URL = 'https://script.google.com/macros/s/AKfycbzdHJwubTl3Gbev0ASbENw1K6aiOkX-hFBy5TxoGBqaptCHsiLyg69jE_GkJ14mlhgV/exec';
            
            try {
                const response = await fetch(GAS_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `data=${encodeURIComponent(JSON.stringify(formData))}`
                });
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Error:', error);
                return { status: 'error', message: 'Gagal mengirim data ke spreadsheet' };
            }
        }

        // Fungsi untuk mengumpulkan data formulir
        function kumpulkanDataFormulir() {
            const namaLengkap = document.querySelector('input[placeholder="Masukkan nama lengkap"]').value;
            const jabatan = document.querySelector('select').value;
            const alasanKegunaan = document.querySelector('textarea[placeholder*="alasan"]').value;
            const tingkatUrgensi = document.querySelector('input[name="urgensi"]:checked')?.value || '';
            const catatanTambahan = document.querySelector('textarea[placeholder*="Catatan"]').value;
            
            // Kumpulkan data barang
            const barang = [];
            let grandTotal = 0;
            
            document.querySelectorAll('.barang-item').forEach(item => {
                const nama = item.querySelector('input[placeholder="Nama barang"]').value;
                const spesifikasi = item.querySelector('input[placeholder="Spesifikasi"]').value;
                const jumlah = item.querySelector('.jumlah').value;
                const harga = item.querySelector('.harga').value;
                const total = jumlah * harga;
                
                if (nama && jumlah && harga) {
                    barang.push({
                        nama: nama,
                        spesifikasi: spesifikasi,
                        jumlah: jumlah,
                        harga: harga,
                        total: total
                    });
                    grandTotal += total;
                }
            });
            
            return {
                namaLengkap: namaLengkap,
                jabatan: jabatan,
                barang: barang,
                alasanKegunaan: alasanKegunaan,
                tingkatUrgensi: tingkatUrgensi,
                catatanTambahan: catatanTambahan,
                grandTotal: grandTotal
            };
        }

        // Fungsi untuk memuat data dari CSV
        async function muatDataCSV() {
            const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT6agBMoySJmuHARMMVDQqZ9vgy7n91XdooMFjK5RA6WSHBnKlbd0W2mr7hU-mfllyhMiQZTMaEoMnp/pub?output=csv';
            
            try {
                const response = await fetch(CSV_URL);
                const csvText = await response.text();
                
                // Parse CSV
                const lines = csvText.split('\n');
                const headers = lines[0].split(',');
                const data = [];
                
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = lines[i].split(',');
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header.trim()] = values[index] ? values[index].trim() : '';
                        });
                        data.push(row);
                    }
                }
                
                return data;
            } catch (error) {
                console.error('Error loading CSV:', error);
                return [];
            }
        }

        // Fungsi untuk menampilkan dashboard
        async function tampilkanDashboard() {
            // Sembunyikan form, tampilkan dashboard
            document.querySelector('form').style.display = 'none';
            document.getElementById('dashboard').classList.remove('hidden');
            
            // Tampilkan loading
            document.getElementById('loading-dashboard').classList.remove('hidden');
            document.getElementById('dashboard-content').classList.add('hidden');
            
            // Muat data
            const data = await muatDataCSV();
            
            // Sembunyikan loading, tampilkan content
            document.getElementById('loading-dashboard').classList.add('hidden');
            document.getElementById('dashboard-content').classList.remove('hidden');
            
            // Proses dan tampilkan data
            prosesDataDashboard(data);
        }

        // Fungsi untuk memproses data dashboard
        function prosesDataDashboard(data) {
            if (data.length === 0) {
                document.getElementById('dashboard-content').innerHTML = '<div class="text-center py-12"><p class="text-gray-500">Belum ada data pengajuan</p></div>';
                return;
            }

            // Hitung statistik
            const totalPengajuan = data.length;
            let totalNilai = 0;
            let totalMendesak = 0;
            const pengajuUnik = new Set();
            const urgensiCount = {};
            const jabatanCount = {};

            data.forEach(row => {
                // Total nilai
                const grandTotal = row['Grand Total'] || row['Total Keseluruhan'] || '0';
                const nilai = parseInt(grandTotal.replace(/[^\d]/g, '')) || 0;
                totalNilai += nilai;

                // Pengaju unik
                const nama = row['Nama Lengkap'] || '';
                if (nama) pengajuUnik.add(nama);

                // Urgensi
                const urgensi = row['Tingkat Urgensi'] || '';
                if (urgensi === 'sangat-mendesak') totalMendesak++;
                urgensiCount[urgensi] = (urgensiCount[urgensi] || 0) + 1;

                // Jabatan
                const jabatan = row['Jabatan'] || '';
                jabatanCount[jabatan] = (jabatanCount[jabatan] || 0) + 1;
            });

            // Update summary cards
            document.getElementById('total-pengajuan').textContent = totalPengajuan;
            document.getElementById('total-nilai').textContent = 'Rp ' + totalNilai.toLocaleString('id-ID');
            document.getElementById('total-mendesak').textContent = totalMendesak;
            document.getElementById('total-pengaju').textContent = pengajuUnik.size;

            // Buat chart urgensi
            buatChartUrgensi(urgensiCount, totalPengajuan);

            // Buat chart jabatan
            buatChartJabatan(jabatanCount, totalPengajuan);

            // Tampilkan pengajuan terbaru
            tampilkanPengajuanTerbaru(data.slice(-10).reverse());
        }

        // Fungsi untuk membuat chart urgensi
        function buatChartUrgensi(urgensiCount, total) {
            const container = document.getElementById('urgensi-chart');
            container.innerHTML = '';

            const urgensiLabels = {
                'sangat-mendesak': { label: 'Sangat Mendesak', color: 'bg-red-500', icon: 'üî¥' },
                'perlu': { label: 'Perlu', color: 'bg-yellow-500', icon: 'üü°' },
                'tidak-mendesak': { label: 'Tidak Mendesak', color: 'bg-green-500', icon: 'üü¢' }
            };

            Object.entries(urgensiLabels).forEach(([key, config]) => {
                const count = urgensiCount[key] || 0;
                const percentage = total > 0 ? (count / total * 100).toFixed(1) : 0;

                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                item.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <span class="text-lg">${config.icon}</span>
                        <span class="font-medium text-gray-700">${config.label}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-20 bg-gray-200 rounded-full h-2">
                            <div class="${config.color} h-2 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                        <span class="text-sm font-semibold text-gray-600">${count} (${percentage}%)</span>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // Fungsi untuk membuat chart jabatan
        function buatChartJabatan(jabatanCount, total) {
            const container = document.getElementById('jabatan-chart');
            container.innerHTML = '';

            const jabatanLabels = {
                'kepala-sekolah': 'Kepala Sekolah',
                'wakil-kepala': 'Wakil Kepala',
                'guru': 'Guru',
                'pembina-ekskul': 'Pembina Ekskul',
                'tas': 'TAS',
                'caraka': 'Caraka'
            };

            const colors = ['bg-blue-500', 'bg-green-500', 'bg-purple-500', 'bg-pink-500', 'bg-indigo-500', 'bg-orange-500'];

            Object.entries(jabatanCount).forEach(([jabatan, count], index) => {
                const percentage = total > 0 ? (count / total * 100).toFixed(1) : 0;
                const label = jabatanLabels[jabatan] || jabatan;
                const color = colors[index % colors.length];

                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                item.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-4 h-4 ${color} rounded"></div>
                        <span class="font-medium text-gray-700">${label}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <div class="w-20 bg-gray-200 rounded-full h-2">
                            <div class="${color} h-2 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                        <span class="text-sm font-semibold text-gray-600">${count} (${percentage}%)</span>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // Fungsi untuk menampilkan pengajuan terbaru
        function tampilkanPengajuanTerbaru(data) {
            const tbody = document.getElementById('recent-submissions');
            tbody.innerHTML = '';

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-100 hover:bg-gray-50';

                const tanggal = row['Timestamp'] || '';
                const nama = row['Nama Lengkap'] || '';
                const jabatan = row['Jabatan'] || '';
                const totalNilai = row['Grand Total'] || row['Total Keseluruhan'] || '0';
                const urgensi = row['Tingkat Urgensi'] || '';

                const urgensiColors = {
                    'sangat-mendesak': 'bg-red-100 text-red-800',
                    'perlu': 'bg-yellow-100 text-yellow-800',
                    'tidak-mendesak': 'bg-green-100 text-green-800'
                };

                tr.innerHTML = `
                    <td class="p-3">${new Date(tanggal).toLocaleDateString('id-ID')}</td>
                    <td class="p-3 font-medium">${nama}</td>
                    <td class="p-3">${jabatan}</td>
                    <td class="p-3 font-semibold">${totalNilai}</td>
                    <td class="p-3">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${urgensiColors[urgensi] || 'bg-gray-100 text-gray-800'}">
                            ${urgensi}
                        </span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Fungsi untuk kembali ke form
        function kembaliKeForm() {
            document.querySelector('form').style.display = 'block';
            document.getElementById('dashboard').classList.add('hidden');
        }

        // Inisialisasi event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Update tanggal dan jam
            updateDateTime();
            setInterval(updateDateTime, 1000); // Update setiap detik
            
            document.querySelectorAll('.barang-item').forEach(item => {
                addEventListeners(item);
            });

            // Event listener untuk tombol Lihat Progress
            document.getElementById('lihat-progress').addEventListener('click', tampilkanDashboard);

            // Event listener untuk tombol Kembali ke Form
            document.getElementById('kembali-form').addEventListener('click', kembaliKeForm);

            // Handle form submission
            document.querySelector('form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Validasi form
                const formData = kumpulkanDataFormulir();
                
                if (!formData.namaLengkap) {
                    alert('Nama lengkap harus diisi!');
                    return;
                }
                
                if (!formData.jabatan) {
                    alert('Jabatan harus dipilih!');
                    return;
                }
                
                if (formData.barang.length === 0) {
                    alert('Minimal harus ada satu barang yang diajukan!');
                    return;
                }
                
                if (!formData.alasanKegunaan) {
                    alert('Alasan kegunaan harus diisi!');
                    return;
                }
                
                if (!formData.tingkatUrgensi) {
                    alert('Tingkat urgensi harus dipilih!');
                    return;
                }
                
                // Tampilkan loading
                const submitBtn = document.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '‚è≥ Mengirim Data...';
                submitBtn.disabled = true;
                
                // Kirim data ke spreadsheet
                const result = await kirimKeSpreadsheet(formData);
                
                // Reset button
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                
                if (result.status === 'success') {
                    alert('‚úÖ Pengajuan sudah terekam, silahkan lihat progress');
                    
                    // Reset form
                    document.querySelector('form').reset();
                    
                    // Reset barang items ke satu item
                    const container = document.getElementById('barang-container');
                    const items = container.querySelectorAll('.barang-item');
                    for (let i = 1; i < items.length; i++) {
                        items[i].remove();
                    }
                    
                    // Reset total
                    hitungGrandTotal();
                } else {
                    alert('‚ùå Gagal mengirim data: ' + result.message + '\n\nSilakan coba lagi atau hubungi administrator.');
                }
            });
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97fd1a10b0945e3c',t:'MTc1Nzk5MTUwMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
